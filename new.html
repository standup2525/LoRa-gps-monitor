<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì„¼ì„œ ë°ì´í„° ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-mono p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-green-300 mb-4">ğŸ“Š ì‹¤ì‹œê°„ / DB ë¡œê·¸ ëŒ€ì‹œë³´ë“œ</h1>

    <!-- ìƒë‹¨ ìš”ì•½ -->
    <div id="summaryTop" class="bg-gray-800 p-3 rounded-lg text-sm mb-5 text-gray-300">ë¡œë”© ì¤‘...</div>

    <!-- íƒ­ -->
    <div class="flex space-x-4 mb-4">
      <button id="liveTab" class="px-4 py-2 bg-green-500 text-gray-900 font-bold rounded">ğŸŒ ì‹¤ì‹œê°„ ë³´ê¸°</button>
      <button id="dbTab" class="px-4 py-2 bg-gray-700 text-gray-300 rounded">ğŸ“… DB ì¡°íšŒ</button>
    </div>

    <!-- ğŸŒ ì‹¤ì‹œê°„ ë³´ê¸° -->
    <div id="liveView">
      <!--ì¸¡ìœ„-->
      <div id="stateCard" class="p-4 rounded-lg bg-gray-800 flex justify-between items-center mb-4">
        <div>
          <p class="text-2xl font-bold" id="state">ì¸¡ìœ„: -</p>
        </div>
      </div>

      <!-- ì„¼ì„œ ê°’ 3ê°œ -->
      <div class="grid gap-4 text-center mb-4 grid-cols-[repeat(auto-fit,minmax(180px,1fr))]">
        <div class="bg-gray-800 p-4 rounded-lg">
          <p>ğŸ—ºï¸ GPS</p>
          <p class="text-2xl font-bold text-red-400" id="gpsState">--</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg">
          <p>â˜€ï¸ ìì™¸ì„ (UV)</p>
          <p id="uv" class="text-2xl font-bold text-purple-400">--</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg">
          <p>ğŸ’¡ ì¡°ë„(Lux)</p>
          <p id="lux" class="text-2xl font-bold text-yellow-400">--</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg">
          <p>â›… ê¸°ì••(hPa)</p>
          <p id="pressure" class="text-2xl font-bold text-blue-400">--</p>
        </div>
      </div>
      <!-- âœ… LoRa ìƒíƒœ + ê±°ë¦¬ í‘œì‹œ -->
      <div class="grid gap-4 text-center mb-4 grid-cols-[repeat(auto-fit,minmax(180px,1fr))]">
        <div class="bg-gray-800 p-4 rounded-lg">
          <p>ğŸ“¡ LoRa ìƒíƒœ</p>
          <p id="loraStatus" class="text-2xl font-bold text-green-400">--</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg">
          <p>ğŸ“ ê±°ë¦¬ (m)</p>
          <p id="loraDistance" class="text-2xl font-bold text-blue-400">--</p>
        </div>
      </div>


      <!-- ìµœê³ ì†ë„ í…ŒìŠ¤íŠ¸ -->
      <div class="flex justify-between items-center">
        <button id="testBtn" class="bg-green-400 hover:bg-green-500 text-gray-900 font-bold py-2 px-4 rounded">âš¡ ìµœê³ ì†ë„ ì¸¡ì •</button>
        <p id="maxspeed" class="text-gray-300">ğŸš€ ìµœê³ ì†ë„: - KB/s</p>
      </div>

      <!-- ë°ì´í„° ì·¨ë“ ë²„íŠ¼ -->
      <div class="flex justify-center space-x-4 mb-4">
        <button id="btnIndoor" class="bg-blue-400 hover:bg-blue-500 text-gray-900 font-bold py-2 px-4 rounded">Indoor</button>
        <button id="btnOutdoor" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-2 px-4 rounded">Outdoor</button>
        <button id="btnSemiOutdoor" class="bg-purple-400 hover:bg-purple-500 text-gray-900 font-bold py-2 px-4 rounded">SemiOutdoor</button>
      </div>
    </div>

    <!-- ğŸ“… DB ì¡°íšŒ -->
    <div id="dbView" class="hidden">
      <div class="flex items-center space-x-4 mb-4">
        <label>ì‹œì‘ì‹œê°„:</label><input type="datetime-local" id="startTime" class="bg-gray-800 text-green-300 border border-gray-600 rounded px-2 py-1">
        <label>ì¢…ë£Œì‹œê°„:</label><input type="datetime-local" id="endTime" class="bg-gray-800 text-green-300 border border-gray-600 rounded px-2 py-1">
        <button id="searchBtn" class="bg-green-400 hover:bg-green-500 text-gray-900 font-bold py-1 px-3 rounded">ì¡°íšŒ</button>
        <button id="exportBtn" class="bg-blue-400 hover:bg-blue-500 text-gray-900 font-bold py-1 px-3 rounded">CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>            
      <div class="flex space-x-2 mb-4">
        <button id="btnIndoor"class="bg-blue-400 hover:bg-blue-500 text-gray-900 font-bold py-1 px-3 rounded" onclick="setLabelAndLoad('Indoor')">Indoor</button>
        <button id="btnOutdoor"class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-1 px-3 rounded" onclick="setLabelAndLoad('Outdoor')">Outdoor</button>
        <button id="btnSemiOutdoor"class="bg-purple-400 hover:bg-purple-500 text-gray-900 font-bold py-1 px-3 rounded" onclick="setLabelAndLoad('SemiOutdoor')">SemiOutdoor</button>
      </div>
      <!-- âœ… ìŠ¤í¬ë¡¤ ì˜ì—­ ì¶”ê°€ -->
      <div class="overflow-y-auto max-h-[500px] border border-gray-700 rounded-lg">
        <table class="w-full text-sm text-gray-200">
          <thead class="bg-gray-700 text-gray-100 sticky top-0">
            <tr>
              <th class="px-2">ì‹œê°„</th>
              <th class="px-2">GPS</th>
              <th class="px-2">UVI</th>
              <th class="px-2">ì¡°ë„(lux)</th>
              <th class="px-2">ê¸°ì••(hPa)</th>
              <th class="px-2">ìƒíƒœ</th>
              <th class="px-2">ì ìˆ˜</th>
            </tr>
          </thead>
          <tbody id="dataBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
// ====================== íƒ­ ì „í™˜ ======================
const liveTab=document.getElementById("liveTab");
const dbTab=document.getElementById("dbTab");
const liveView=document.getElementById("liveView");
const dbView=document.getElementById("dbView");

liveTab.onclick=()=>{
  liveView.classList.remove("hidden");
  dbView.classList.add("hidden");
  liveTab.classList.add("bg-green-500","text-gray-900");
  dbTab.classList.remove("bg-green-500","text-gray-900");
  dbTab.classList.add("bg-gray-700","text-gray-300");
};
dbTab.onclick=()=>{
  dbView.classList.remove("hidden");
  liveView.classList.add("hidden");
  dbTab.classList.add("bg-green-500","text-gray-900");
  liveTab.classList.remove("bg-green-500","text-gray-900");
  liveTab.classList.add("bg-gray-700","text-gray-300");
};

// ====================== DB ì¡°íšŒ ======================
const searchBtn=document.getElementById("searchBtn");
const exportBtn=document.getElementById("exportBtn");
const dataBody=document.getElementById("dataBody");
const summaryTop=document.getElementById("summaryTop");


searchBtn.onclick=async()=>{
  const start=document.getElementById("startTime").value.replace("T"," ");
  const end=document.getElementById("endTime").value.replace("T"," ");
  const url=`/api/data?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
  const res=await fetch(url);
  const data=await res.json();
  dataBody.innerHTML="";
  for(const row of data){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="border-t px-2">${row.timestamp ?? '-'}</td>
                  <td class="border-t px-2">${row.gps_fix ?? '-'}</td>
                  <td class="border-t px-2">${row.uv != null ? row.uv.toFixed(2) : '--'}</td>
                  <td class="border-t px-2">${row.lux != null ? row.lux.toFixed(0) : '--'}</td>
                  <td class="border-t px-2">${row.pressure != null ? row.pressure.toFixed(2) : '--'}</td>
                  <td class="border-t px-2">${row.state ?? '-'}</td>
                  <td class="border-t px-2">${row.score != null ? row.score.toFixed(3) : '--'}</td>`;
    dataBody.appendChild(tr);
  }
};

// ğŸ“¤ CSV ë‹¤ìš´ë¡œë“œ
exportBtn.onclick = () => {
  const start = document.getElementById("startTime").value.replace("T", " ");
  const end = document.getElementById("endTime").value.replace("T", " ");
  const label = window.currentLabel || ""; // ë¼ë²¨ë²„íŠ¼ ëˆŒë €ìœ¼ë©´ ê±°ê¸° ê¸°ë¡

  let url = `/api/export_csv?`;
  if (start) url += `start=${encodeURIComponent(start)}&`;
  if (end) url += `end=${encodeURIComponent(end)}&`;
  if (label) url += `label=${encodeURIComponent(label)}&`;

  window.location.href = url;
};

// âœ… ë¼ë²¨ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ í˜„ì¬ ì„ íƒ ë¼ë²¨ ì €ì¥
function setLabelAndLoad(label) {
  window.currentLabel = label; // export ì‹œ ì°¸ê³ 
  loadLabelData(label);
}


// ====================== í†µê³„ ìš”ì•½ ======================
async function loadSummary(){
  const res=await fetch("/api/summary");
  const sum=await res.json();
  const text=`ì „ì²´ ${sum.rows}ê°œ |
    â˜€ï¸ UVI í‰ê·  ${sum.uv.avg?.toFixed(3)} |
    ğŸ’¡ ì¡°ë„ í‰ê·  ${sum.lux.avg?.toFixed(1)} |
    â›… ê¸°ì•• í‰ê·  ${sum.pressure.avg?.toFixed(2)}`;
  summaryTop.textContent=text;

}
loadSummary();

// ====================== ì‹¤ì‹œê°„ WebSocket í‘œì‹œ ======================
const ws = new WebSocket(`ws://192.168.0.22:8765`);
let testing = false;
let maxSpeed = 0;
let lastSensor = null;

ws.onopen = () => console.log("[WS] ì—°ê²°ë¨");
ws.onclose = () => console.warn("[WS] ì—°ê²° ëŠê¹€");
ws.onerror = e => console.error("[WS ERROR]", e);

ws.onmessage = e => {
  if (!e.data) return;

  let data;
  try {
    data = JSON.parse(e.data);
  } catch {
    return;
  }

  // âš¡ ìµœê³ ì†ë„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì‹œ
  if (data.test_done && data.lora_result) {
    const result = data.lora_result;
    const { packets, bytes, time, bps, kbps, log_path } = result;

    // === í‰ê· ì†ë„/ìµœê³ ì†ë„ ê³„ì‚° ===
    const kbPerSec = (bps / 1024).toFixed(2); // Bytes/s â†’ KB/s
    const mbps = (kbps / 1000).toFixed(3);    // kbps â†’ Mbps

    // ìµœê³ ì†ë„ ê°±ì‹ 
    if (parseFloat(kbPerSec) > maxSpeed) {
      maxSpeed = parseFloat(kbPerSec);
    }

    // === í™”ë©´ ì¶œë ¥ ===
    document.getElementById("maxspeed").innerHTML = `
      ğŸš€ ìµœê³ ì†ë„: <span class="text-pink-400 font-bold">${maxSpeed.toFixed(2)}</span> KB/s
    `;

    // âœ… ê²°ê³¼ ìƒì„¸ í‘œì‹œìš© ë°•ìŠ¤ ì¶”ê°€
    let resultBox = document.getElementById("testResultBox");
    if (!resultBox) {
      resultBox = document.createElement("div");
      resultBox.id = "testResultBox";
      resultBox.className = "mt-4 p-3 rounded-lg bg-gray-800 text-sm text-gray-200 border border-gray-700";
      document.querySelector("#liveView").appendChild(resultBox);
    }

    resultBox.innerHTML = `
      <p>ğŸ“¦ <b>íŒ¨í‚· ìˆ˜:</b> ${packets}</p>
      <p>ğŸ’¾ <b>ì´ ë°ì´í„°ëŸ‰:</b> ${bytes} Bytes</p>
      <p>â±ï¸ <b>ì´ ì†Œìš”ì‹œê°„:</b> ${time} s</p>
      <p>ğŸ“ˆ <b>í‰ê·  ì†ë„:</b> ${bps} B/s (${kbps} kbps)</p>
      <p>ğŸ“„ <b>ë¡œê·¸ ê²½ë¡œ:</b> ${log_path}</p>
    `;

    testing = false;
    console.log(`[TEST DONE] ${kbps} kbps (${kbPerSec} KB/s)`);
    return;
  }

  // === ì„¼ì„œ ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ===
  if (!testing && data.timestamp) {
    const gpsFix = data.gps_fix === "A" ? "ì‹ í˜¸ìˆìŒ" : "ì‹ í˜¸ì—†ìŒ";
    document.getElementById("gpsState").textContent = gpsFix;
    document.getElementById("state").textContent = `ì¸¡ìœ„: ${data.state}`;
    document.getElementById("uv").textContent = data.uv?.toFixed(2) ?? "--";
    document.getElementById("lux").textContent = data.lux?.toFixed(0) ?? "--";
    document.getElementById("pressure").textContent = data.pressure?.toFixed(2) ?? "--";
    document.getElementById("loraStatus").textContent = data.lora ?? "--";
    if (data.lora_dist) {
      document.getElementById("loraDistance").textContent = `${data.lora_dist.toFixed(1)} m`;
    }
    lastSensor = data;
  }
};

// âœ… ìµœê³ ì†ë„ í…ŒìŠ¤íŠ¸ ë²„íŠ¼
const testBtn = document.getElementById("testBtn");
testBtn.onclick = () => {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send("start_test");
    testing = true;
    maxSpeed = 0;

    // UI ì´ˆê¸°í™”
    
    document.getElementById("maxspeed").textContent = "ğŸš€ ê³„ì‚° ì¤‘...";
    const existing = document.getElementById("testResultBox");
    if (existing) existing.remove();

    console.log("[TEST] LoRa ë‹¨ë°©í–¥ ì†ë„í…ŒìŠ¤íŠ¸ ì‹œì‘");
  } else {
    alert("âŒ WebSocket ì—°ê²°ì´ ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
  }
};


// âœ… ë¼ë²¨ ì €ì¥ í•¨ìˆ˜ (ë²„íŠ¼ ìƒ‰ í”¼ë“œë°± ë²„ì „)
async function saveLabel(label) {
  const btn = document.getElementById(`btn${label}`);
  if (!lastSensor) {
    const original = btn.textContent;
    btn.textContent = "âš ï¸ ë°ì´í„° ì—†ìŒ";
    btn.className = btn.className.replace(/bg-[a-z]+-\d+/g, ""); // ê¸°ì¡´ bg-* ì „ë¶€ ì œê±°
    btn.classList.add("bg-red-500");
    btn.disabled = true;

    setTimeout(() => {
      btn.textContent = original;
      btn.className = btn.className.replace(/bg-[a-z]+-\d+/g, ""); // ë‹¤ì‹œ ìƒ‰ìƒ ì´ˆê¸°í™”
      btn.classList.add(`bg-${label === "Indoor" ? "blue" : label === "Outdoor" ? "yellow" : "purple"}-400`);
      btn.disabled = false;
    }, 1200);
    return;
  }

  btn.disabled = true;
  const original = btn.textContent;
  btn.textContent = "â³ ì €ì¥ ì¤‘...";
  btn.className = btn.className.replace(/bg-[a-z]+-\d+/g, "");
  btn.classList.add("bg-blue-500");

  try {
    const res = await fetch("/api/label", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ label, values: lastSensor })
    });

    if (res.ok) {
      const result = await res.json();
      btn.textContent = "âœ… ì €ì¥ë¨";
      btn.className = btn.className.replace(/bg-[a-z]+-\d+/g, "");
      btn.classList.add("bg-green-500");
      console.log(`[OK] ${result.label} ë°ì´í„° ì €ì¥ ì™„ë£Œ`);
    } else {
      throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
    }
  } catch (err) {
    console.error(err);
    btn.textContent = "âŒ ì‹¤íŒ¨";
    btn.className = btn.className.replace(/bg-[a-z]+-\d+/g, "");
    btn.classList.add("bg-red-500");
  }

  setTimeout(() => {
    btn.textContent = original;
    btn.className = btn.className.replace(/bg-[a-z]+-\d+/g, "");
    btn.classList.add(`bg-${label === "Indoor" ? "blue" : label === "Outdoor" ? "yellow" : "purple"}-400`);
    btn.disabled = false;
  }, 1500);
}

// âœ… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
document.getElementById("btnIndoor").onclick = () => saveLabel("Indoor");
document.getElementById("btnOutdoor").onclick = () => saveLabel("Outdoor");
document.getElementById("btnSemiOutdoor").onclick = () => saveLabel("SemiOutdoor");

async function loadLabelData(label){
  const res = await fetch(`/api/label_data?label=${encodeURIComponent(label)}`);
  const data = await res.json();
  const body = document.getElementById("dataBody");
  body.innerHTML = "";
  for(const row of data){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="border-t px-2">${row.timestamp}</td>
                    <td class="border-t px-2">${row.gps_fix ?? '-'}</td>
                    <td class="border-t px-2">${row.uv?.toFixed(2)}</td>
                    <td class="border-t px-2">${row.lux?.toFixed(0)}</td>
                    <td class="border-t px-2">${row.pressure?.toFixed(2)}</td>`;
    body.appendChild(tr);
  }
}
</script>
</body>
</html>
